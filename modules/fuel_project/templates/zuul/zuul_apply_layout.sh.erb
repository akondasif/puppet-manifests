#!/bin/bash

ZUUL_LAYOUTDIR="$(dirname '<%= zuul_layout %>')"
<% if @config_update_method == 'jenkins' -%>
JENKINS_JOB_URL="<%= jenkins_url %>/job/<%= jenkins_job %>/lastSuccessfulBuild/artifact/build/<%= @fqdn %>"
<% end -%>
ZUUL_RELOAD="false"
ZUUL_TEMP="$(mktemp -d)"

diff_config() {
    diff -u "${ZUUL_LAYOUTDIR}/${1}" "${ZUUL_TEMP}/${1}"
}
<% if @config_update_method == 'jenkins' -%>
# Get configs from Jenkins
curl -fLsS -o "${ZUUL_TEMP}/layout.yaml" "${JENKINS_JOB_URL}/layout.yaml"
curl -fLsS -o "${ZUUL_TEMP}/external_functions.py" "${JENKINS_JOB_URL}/external_functions.py"
<% end -%>
<% if @config_update_method == 'repository' -%>
cp <%= @project_config_zuul_yaml_path %> "${ZUUL_TEMP}/layout.yaml"
cp <%= @project_config_zuul_ext_funct_path %> "${ZUUL_TEMP}/external_functions.py"
<% end -%>

# If files are not changed - just exit
if diff_config layout.yaml && diff_config external_functions.py; then
    echo "No changes"
    rm -rf "${ZUUL_TEMP}"
    exit 0
fi

# Verify configs
if ! zuul-server -t -l "${ZUUL_TEMP}/layout.yaml" &>/dev/null; then
    echo "ERROR: Syntax error"
    rm -rf "${ZUUL_TEMP}"
    exit 1
fi

# Diff and apply if needed
if ! diff_config layout.yaml &>/dev/null; then
    cp "${ZUUL_TEMP}/layout.yaml" "${ZUUL_LAYOUTDIR}"
    ZUUL_RELOAD="true"
fi

if ! diff_config external_functions.py &>/dev/null; then
    cp "${ZUUL_TEMP}/external_functions.py" "${ZUUL_LAYOUTDIR}"
    ZUUL_RELOAD="true"
fi

if [ "${ZUUL_RELOAD}" ]; then
    echo "Configuration changed, reload zuul service"
    kill -HUP "$(/sbin/initctl status zuul | awk '{print $NF}')"
fi

rm -rf "${ZUUL_TEMP}"
